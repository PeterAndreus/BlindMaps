 
<!DOCTYPE html>
<html>
    <head>
        <title>Image Vector Layer</title>
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/claro/claro.css">
        <link rel="stylesheet" href="http://openlayers.org/en/v3.13.1/css/ol.css" type="text/css">
        <script src="http://openlayers.org/en/v3.13.1/build/ol.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js" data-dojo-config="parseOnLoad: true"></script>

    </head>
    <body class="claro bodyClass">
        <style>
            html{
                min-height:100%;
                position:relative;
            }
            body{
                height:100%;
            }
            table{
                width: 100%;
            }
            td{
                height: 20px;
            }
            .dijitTitlePaneTitleFocus{
                text-align: right;
                font-family: monospace;
            }
            .divMap{
                position:absolute;
                top:0;
                bottom:0;
                left:0;
                right:0;
                overflow:hidden;
            }
            .topDiv{
                font-family: monospace;
                position: absolute;
                width: 100%;
                top: 0;
                right: 0;
                background-color: RGBA(61, 98, 121, 0.85);
            }
            .center{
                text-align: center;
            }
            .next{
                position: absolute;
                right: 0;
                margin-top: 5px;
            }
            .whiteBorder{
                border: 2px solid white;
            }
            .bodyClass{
                background-color: #B3E5FC;
            }
            .taskInfo{
                color: white;
                font-family: monospace;
                font-size: 1.6em;
            }
            .task{
                color: gainsboro;
                font-family: georgia;
                font-size: 3em;
                font-weight: bold;
                display: inline-block;
                height: 100%;
            }
            .answerInfo{
                float: right;
                color: white;
                font-size: 10px;
                margin-right: 7px;
            }
            #taskDiv{
                margin-top: 10px;
                margin-bottom: 4px;
            }
            .flagTask{               
            }
            .areaTr{
                width: 15%;
            }
            .slider{
                width: 90%;
            }
            .claro .dijitTitlePaneTitle{
                background-color: #6599BA;
                background-image: none;
                color:white;
            }
            .claro .dijitTitlePaneTitleHover,
            .claro .dijitTitlePaneTitleOpen{
                background-color: RGBA(61, 98, 121, 0.85);
                background-image: none;
                color: white;
            }
            .claro .dijitTitlePaneContentOuter {
                background: rgba(255, 255, 255, 0.57);
                color: white;
            }
            .claro .dijitButton .dijitButtonNode{
                background-color: #b6b6b6;
            }
        </style>
        <div class="divMap">
            <div id="map" class="map" style="height: 100%" ></div>
        </div>
        <div class="topDiv">
            <div id='settings'>
                <div data-dojo-type="dijit/form/Form" id="settingForm">
                    <div>
                        <div data-dojo-type="dijit/TitlePane" title="Settings" data-dojo-props='open: false, duration: 200'>
                            <div data-dojo-type="dijit/layout/ContentPane" >
                                Country area:
                                <table>
                                    <tr>
                                        <td>
                                            Minimum:
                                            <div data-dojo-type="dijit/form/TextBox"
                                                 name = "minArea"
                                                 onChange="changeSetting(this)"
                                                 value="5000"
                                                 placeHolder="minimal country area"></div>
                                            km<sup>2</sup>
                                        </td>
                                        <td>
                                            <input id="keepAnswer" name="keepAnswer" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="keepAnswer">Keep correct answer highlighted</label>
                                        </td>
                                        <td>
                                            <input id="americas" name="region" value="Americas" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="americas">North and South America</label>
                                        </td>
                                        <td class="center" rowspan="5">
                                            <a href="javascript:void(0)" onClick="simpleMode()">
                                                <img class="whiteBorder" src="data/images/simple.png" alt="simple"><br/>
                                                Simple Mode
                                            </a>
                                        </td>
                                        <td class="center" rowspan="5">
                                            <a href="javascript:void(0)" onClick="satMode()">
                                                <img class="whiteBorder" src="data/images/sat.png" alt="satellite"><br/>
                                                Satellite Mode
                                            </a>
                                        </td>
                                        <td class="center" rowspan="5">
                                            <a href="javascript:void(0)" onClick="godMode()">
                                                <img class="whiteBorder" src="data/images/god.png" alt="god mode"><br/>
                                                GOD Mode
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            Maximum:
                                            <div data-dojo-type="dijit/form/TextBox"
                                                 name = "maxArea"
                                                 onChange="changeSetting(this)"
                                                 value="17098242"
                                                 placeHolder="maximal country area"></div>
                                            km<sup>2</sup>
                                        </td>
                                        <td>
                                            <input id="names" value="names" name="taskStyle" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="names">Show name task</label>
                                        </td>
                                        <td>
                                            <input id="europe" name="region" value="Europe" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="europe">Europe</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td>
                                            <input id="flags" name="taskStyle" value="flags" data-dojo-type="dijit/form/CheckBox"  onChange="changeSetting(this)"/>
                                            <label for="flags">Show flag task</label>
                                        </td>
                                        <td>
                                            <input id="australia" name="region" value="Oceania" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="australia">Australia & Oceania</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td>
                                            <input id="capital" name="capitalStyle" value="capital" data-dojo-type="dijit/form/CheckBox"  onChange="changeSetting(this)"/>
                                            <label for="capital">Show capital city</label>
                                        </td>
                                        <td>
                                            <input id="asia" name="region" value="Asia" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="asia">Asia</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <input id="africa" name="region" value="Africa" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                            <label for="africa">Africa</label>
                                        </td>
                                    </tr>
                                </table>
                                <button data-dojo-type="dijit/form/Button" type="button">Restart
                                    <script type="dojo/on" data-dojo-event="click" data-dojo-args="evt">
                                        initSettings();
                                    </script>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id='taskDiv' class="center">
                <span class='taskInfo' id='taskInfoSpan'></span>
                <span class='task' id='taskSpan'></span>
                <div class='answerInfo' id='answerInfoSpan'>
                    <table>
                        <tr>
                            <td>Correct:&nbsp;</td>
                            <td>
                                <span id='correctCount'>0</span>
                            </td>
                        </tr>
                        <tr>
                            <td>Wrong:&nbsp;</td>
                            <td><span id='wrongCount'>0</span></td>
                        </tr>
                    </table>
                </div>
                <div class="next">
                    <a href="javascript:void(0)" onClick="nextTask()">
                        <img src="data/images/nextTask.png" alt="Next task">
                    </a>
                </div>
            </div>
        </div>
        <script>

            var settings;
            var countryData;
            var correctAnswers = [];
            var filteredData;
            var taskCountry;
            var highlightFeature;
            var wrongCounter = 0;
            var correctCounter = 0;
            var UNCODE = "wb_a3_2";
            var godModeActivated = false;

            var satLayer = new ol.layer.Tile({
                source: new ol.source.MapQuest({layer: 'sat'})
            });

            var vectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    loader: function() {
                        var source = this;
                        var format = new ol.format.TopoJSON();
                        dojo.xhrGet({
                            url: "data/countries_topojson.json",
                            handleAs: "json",
                            load: function(data) {
                                var features = format.readFeatures(data, {
                                    featureProjection: 'EPSG:3857'
                                });
                                source.addFeatures(separateMultiPolygon(features));
                            }
                        });
                    }
                }),
                style: function(feature) {
                    return fillCountry(true);
                }
            });

            var map = new ol.Map({
                layers: [
                    vectorLayer
                ],
                target: 'map',
                view: new ol.View({
                    center: ol.proj.fromLonLat([19, 48]),
                    zoom: 5,
                    maxZoom: 11,
                    minZoom: 3
                })
            });

            var overlayFeature = new ol.layer.Vector({
                source: new ol.source.Vector(),
                map: map,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(0,0,0,1)',
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(0,0,0,0.3)'
                    })
                })
            });

            var correctAnswerFeature = new ol.layer.Vector({
                source: new ol.source.Vector(),
                map: map,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 255, 0, 0.5)'
                    })
                })
            });

            function simpleMode() {
                vectorLayer.setStyle(fillCountry(true));
                if (map.getLayers().getArray().indexOf(vectorLayer) === -1) {
                    map.getLayers().insertAt(1, vectorLayer);
                }
                map.removeLayer(satLayer);
                godModeActivated = false;
                dijit.byId('keepAnswer').set('checked', true);
            }

            function satMode() {
                vectorLayer.setStyle(fillCountry(false));
                if (map.getLayers().getArray().indexOf(vectorLayer) === -1) {
                    map.getLayers().insertAt(1, vectorLayer);
                }
                if (map.getLayers().getArray().indexOf(satLayer) === -1) {
                    map.getLayers().insertAt(0, satLayer);
                }
                godModeActivated = false;
                dijit.byId('keepAnswer').set('checked', true);
            }

            function godMode() {
                if (map.getLayers().getArray().indexOf(satLayer) === -1) {
                    map.getLayers().insertAt(0, satLayer);
                }
                vectorLayer.setStyle(noStyle());
                godModeActivated = true;

                dojo.forEach(overlayFeature.getSource().getFeatures(), function(feature) {
                    overlayFeature.getSource().removeFeature(feature);
                });

                dijit.byId('keepAnswer').set('checked', false);
            }

            function generateUUID() {
                var S4 = function() {
                    return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
                };
                return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
            }

            function separateMultiPolygon(features) {
                var result = [];
                dojo.forEach(features, function(feature) {
                    var geom = feature.getGeometry();
                    if (geom.getType() === 'MultiPolygon') {
                        var mainFeature;
                        var mainArea = 0;
                        dojo.forEach(geom.getPolygons(), function(polygon) {
                            if (polygon.getArea() > mainArea) {
                                var clone = feature.clone();
                                clone.setGeometry(polygon);
                                mainFeature = clone;
                                mainArea = polygon.getArea();
                            }
                        });

                        mainFeature.childFeatures = [mainFeature];
                        mainFeature.mainFeature = true;

                        dojo.forEach(geom.getPolygons(), function(polygon) {
                            if (polygon.getArea() !== mainArea) {
                                var clone = feature.clone();
                                clone.setGeometry(polygon);
                                clone.parentFeature = mainFeature;
                                clone.mainFeature = false;
                                clone.setId(generateUUID());
                                result.push(clone);
                                mainFeature.childFeatures.push(clone);
                            }
                        });

                        result.push(mainFeature);
                    } else {
                        feature.mainFeature = true;
                        feature.childFeatures = [feature];
                        feature.setId(generateUUID());
                        result.push(feature);
                    }
                });

                return result;
            }

            function noStyle() {
                var s = new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 0, 0, 0)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'rgba(0, 0, 0, 0)',
                        width: 0.4
                    })
                });
                return  s;
            }

            function fillCountry(sat) {
                var color = 'rgba(255, 255, 255, 0.4)';
                if (sat) {
                    color = '#FFF8E1';
                }
                var s = new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: color
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'rgba(0, 0, 0, 1)',
                        width: 0.4
                    })
                });
                return  s;
            }

            function highlightFeatureInfo(pixel) {
                var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                    return feature;
                });

                if (feature !== highlightFeature) {
                    if (highlightFeature) {
                        overlayFeature.getSource().removeFeature(highlightFeature);
                    }
                    if (feature) {
                        overlayFeature.getSource().addFeature(feature);
                    } else {
                    }
                    highlightFeature = feature;
                }
            }
            function getWrongVectorLayer() {

                var vLayer = new ol.layer.Vector({
                    source: new ol.source.Vector(),
                    map: map,
                    style: new ol.style.Style({
                        fill: new ol.style.Fill({
                            color: 'rgba(255, 0, 0, 0.5)'
                        })
                    })
                });
                return vLayer;
            }

            function checkCorrectAnswer(pixel) {
                var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                    return feature;
                });

                if (!feature.mainFeature) {
                    feature = feature.parentFeature;
                }

                if (feature && correctAnswers.indexOf(feature.get(UNCODE)) !== -1) {
                    wrongAnswer(feature);
                    return;
                }

                if (taskCountry && feature && feature.get(UNCODE) === taskCountry.ccn3) {
                    var fill = correctAnswerFeature.getStyle().getFill();
                    var keepHighlight = settings.keepAnswer.length === 0;

                    dojo.forEach(feature.childFeatures, function(childFeature) {
                        correctAnswerFeature.getSource().addFeature(childFeature);
                        if (keepHighlight) {
                            correctAnswerAnimate(fill, childFeature);
                        }
                    });

                    correctAnswers.push(taskCountry.ccn3);
                    countAnswer(true);
                    initializeTask();
                } else if (feature) {
                    wrongAnswer(feature);
                }
            }

            function wrongAnswer(feature) {
                var wrongAnswerFeature = getWrongVectorLayer();

                dojo.forEach(feature.childFeatures, function(childFeature) {
                    wrongAnswerFeature.getSource().addFeature(childFeature);
                });
                wrongAnswerAnimate(wrongAnswerFeature, feature.childFeatures);
                countAnswer(false);
            }

            function restart() {
                var vectorSource = correctAnswerFeature.getSource();
                dojo.forEach(vectorSource.getFeatures(), function(feature) {
                    vectorSource.removeFeature(feature);
                });
                correctAnswers = [];
                resetCounter();
                filterDataByCriteria();
            }

            function nextTask() {
                initializeTask();
            }

            function destroyLayer(layer) {
                if (layer) {
                    map.removeLayer(layer);
                    layer = null;
                }
            }

            map.on('pointermove', function(evt) {
                if (evt.dragging) {
                    return;
                }
                var pixel = map.getEventPixel(evt.originalEvent);
                if (!godModeActivated) {
                    highlightFeatureInfo(pixel);
                }
            });

            map.on('click', function(evt) {
                checkCorrectAnswer(evt.pixel);
            });
        </script>
        <script>
            require(["dojo/dom", "dijit/registry", "dojo/dom-class"], function(dom, registry, domClass) {
                changeSetting = function() {
                    initSettings();
                }

                initSettings = function() {
                    var form = registry.byId("settingForm");
                    settings = form.get("value");
                    if (settings.taskStyle.indexOf("flags") !== -1) {
                        domClass.add("taskDiv", "flagTask");
                    } else {
                        domClass.remove("taskDiv", "flagTask");
                    }
                    restart();
                }

                filterDataByCriteria = function() {
                    filteredData = dojo.filter(countryData.features, function(item) {
                        return settings.region.indexOf(item.region) !== -1 &&
                                item.area <= settings.maxArea &&
                                item.area >= settings.minArea;
                    });
                    initializeTask();
                }

                initializeTask = function() {
                    var taskSpan = dom.byId("taskSpan");
                    var taskInfoSpan = dom.byId("taskInfoSpan");
                    if (correctAnswers.length !== filteredData.length) {
                        var country = getRandomCountry();
                        var taskSpanValue = "";

                        taskInfoSpan.innerHTML = "Click on:";
                        if (settings.taskStyle.indexOf("flags") !== -1) {
                            taskSpanValue += "<img class='whiteBorder' src='http://www.geonames.org/flags/x/" + country.cca2.toLowerCase() + ".gif' height='60px'/> &nbsp;";
                        }
                        if (settings.taskStyle.indexOf("names") !== -1) {
                            taskSpanValue += country.name.common;
                        }
                        if (settings.capitalStyle.indexOf("capital") !== -1){
                            if (settings.taskStyle.indexOf("names") !== -1
                                || settings.taskStyle.indexOf("flags") !== -1) {
                                taskSpanValue += "&nbsp - &nbsp";
                            }
                            taskSpanValue += country.capital;
                        }
                        taskSpan.innerHTML = taskSpanValue;
                        taskCountry = country;
                    } else {
                        taskInfoSpan.innerHTML = "";
                        taskSpan.innerHTML = "All answered";
                    }
                };

                getRandomCountry = function() {
                    var randomNum = Math.floor(Math.random() * filteredData.length);
                    var country = filteredData[randomNum];
                    if (correctAnswers.indexOf(country.ccn3) !== -1 || country.ccn3 === "") {
                        country = getRandomCountry();
                    }
                    return country;
                }

                correctAnswerAnimate = function(fill, feature) {
                    var interval = 25;
                    var timer = new dojox.timing.Timer(interval);
                    timer.alpha = 0.5;
                    timer.tickCount = 0;
                    timer.fill = fill;
                    timer.feature = feature;
                    timer.onTick = function() {
                        timer.tickCount++;
                        var alpha = timer.alpha - (timer.alpha / interval * timer.tickCount);
                        timer.fill.setColor('rgba(0, 255, 0, ' + alpha + ')');

                        correctAnswerFeature.getSource().removeFeature(feature);
                        correctAnswerFeature.getSource().addFeature(feature);

                        if (alpha === 0) {
                            correctAnswerFeature.getSource().removeFeature(feature);
                            timer.fill.setColor('rgba(0, 255, 0, ' + timer.alpha + ')');
                            timer.stop();
                        }
                    };
                    timer.start();
                };

                wrongAnswerAnimate = function(wrongAnswerFeature, featureList) {
                    var interval = 25;
                    var timer = new dojox.timing.Timer(interval);
                    timer.alpha = 0.5;
                    timer.tickCount = 0;
                    timer.fill = wrongAnswerFeature.getStyle().getFill();
                    timer.onTick = function() {
                        this.tickCount++;
                        var alpha = this.alpha - (this.alpha / interval * this.tickCount);
                        this.fill.setColor('rgba(255, 0, 0, ' + alpha + ')');
                        var that = this;
                        dojo.forEach(featureList, function(feature) {
                            if (alpha === 0 && feature) {
                                that.fill.setColor('rgba(255, 0, 0, 0)');
                                destroyLayer(wrongAnswerFeature);
                                if (that.isRunning) {
                                    that.stop();
                                }
                            }
                            wrongAnswerFeature.getSource().removeFeature(feature);
                            wrongAnswerFeature.getSource().addFeature(feature);
                        });
                    };
                    timer.start();
                };

                countAnswer = function(correct) {
                    if (correct) {
                        var c = dom.byId('correctCount');
                        correctCounter++;
                        c.innerHTML = correctCounter;
                    } else {
                        var w = dom.byId('wrongCount');
                        wrongCounter++;
                        w.innerHTML = wrongCounter;
                    }
                }

                resetCounter = function() {
                    var c = dom.byId('correctCount');
                    var w = dom.byId('wrongCount');
                    c.innerHTML = "0";
                    w.innerHTML = "0";
                    wrongCounter = 0;
                    correctCounter = 0;
                }
            });
        </script>

        <script>
            require(["dojo/request/xhr", "dojo/ready"], function(xhr, ready) {
                ready(function() {
                    dojo.require("dojox.timing");
                    xhr("data/countries.json",
                            {handleAs: "json"})
                            .then(function(data) {
                                countryData = data;
                                initSettings();
                            });
                })
            });
        </script>
    </body>
</html>