 
<!DOCTYPE html>
<html>
    <head>
        <title>Image Vector Layer</title>
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/claro/claro.css">
        <link rel="stylesheet" href="http://openlayers.org/en/v3.13.1/css/ol.css" type="text/css">
        <script src="http://openlayers.org/en/v3.13.1/build/ol.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js" data-dojo-config="parseOnLoad: true"></script>

    </head>
    <body class="claro bodyClass">
        <style>
            .bodyClass{
                background-color: black;
            }
            .taskInfo{
                color: white;
                font-family: monospace;
                font-size: 1.6em;
            }
            .task{
                color: gainsboro;
                font-size: 2em;
                font-weight: bold;
            }
            .settingTr{
                width: 30%;
            }
            .slider{
                width: 90%;
            }
            .topSlider .dijitSliderRemainingBar{
                background-color: red !important;
            }
            .topSlider .dijitSliderProgressBar{
                background-color: white !important;
            }
            .bottomSlider .dijitSliderRemainingBar{
                background-color: white !important;
            }
            .bottomSlider .dijitSliderProgressBar{
                background-color: red !important;
            }
        </style>
    <center>
        <div id='taskDiv'>
            <span class='taskInfo' id='taskInfoSpan'></span>
            <span class='task' id='taskSpan'></span>
        </div>
    </center>
    <div id='settings'>
        <div data-dojo-type="dijit/form/Form" id="settingForm">
            <div>
                <div data-dojo-type="dijit/TitlePane" title="Settings" data-dojo-props='open: false, duration: 200'>
                    <div data-dojo-type="dijit/layout/ContentPane" >
                        Country area:
                        <div data-dojo-type="dijit/form/HorizontalSlider"
                             class ='topSlider slider'
                             name = 'minArea'
                             onChange="changeSetting(this)"
                             data-dojo-props="
                             minimum: -10,
                             maximum: 17098242,
                             showButtons:false,
                             value: 50000,
                             clickSelect: false">
                            <ol data-dojo-type="dijit/form/HorizontalRuleLabels" container="topDecoration"
                                style="height:1em;font-size:75%;color:gray;">
                                <li>Vatican</li>
                                <li>Russia</li>
                            </ol>
                            <div data-dojo-type="dijit/form/HorizontalRule" container="topDecoration"
                                 count=11 style="height:5px;"></div>
                        </div>
                        <div data-dojo-type="dijit/form/HorizontalSlider"
                             class ='bottomSlider slider'
                             name = 'maxArea'
                             onChange="changeSetting(this)"
                             data-dojo-props="
                             minimum: -10,
                             maximum: 17098242,
                             value: 17098242,
                             showButtons:false,
                             clickSelect: false">
                            <div data-dojo-type="dijit/form/HorizontalRule" container="bottomDecoration"
                                 count=11 style="height:5px;"></div>
                            <ol data-dojo-type="dijit/form/HorizontalRuleLabels" container="bottomDecoration"
                                style="height:1em;font-size:75%;color:gray;">
                                <li>Vatican</li>
                                <li>Russia</li>
                            </ol>
                        </div>

                        <table style="width: 100%">
                            <tr class="settingTr">
                                <td>
                                    <input id="keepAnswer" name="keepAnswer" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="keepAnswer">Keep correct answer highlighted</label>
                                </td>
                                <td>
                                    <input id="northAmerica" name="northAmerica" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="northAmerica">North America</label>
                                </td>
                                <td>
                                    <input id="asia" name="asia" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="asia">Asia</label>
                                </td>
                            </tr>
                            <tr class="settingTr">
                                <td>
                                    <input id="names" name="names" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="names">Show name task</label>
                                </td>
                                <td>
                                    <input id="southAmerica" name="southAmerica" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="southAmerica">South America</label>
                                </td>
                                <td>
                                    <input id="africa" name="africa" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="asia">Africa</label>
                                </td>
                            </tr>
                            <tr class="settingTr">
                                <td>
                                    <input id="flags" name="flags" data-dojo-type="dijit/form/CheckBox"  onChange="changeSetting(this)"/>
                                    <label for="flags">Show flag task</label>
                                </td>
                                <td>
                                    <input id="europe" name="europe" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="europe">Europe</label>
                                </td>
                                <td>
                                    <input id="australia" name="australia" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="australia">Australia</label>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <center>
        <div id="map" class="map" style="width: 80%"></div>
    </center>
    <script>

        var settings;
        var countryData;
        var taskCountry;
        var highlightFeature;
        var opacity = 0.7;
        var colorMap = {
            1: 'rgba(255, 255, 255, ' + (opacity - 0.3) + ')',
            2: 'rgba(50, 205, 50, ' + opacity + ')',
            3: 'rgba(255, 215, 0, ' + opacity + ')',
            4: 'rgba(255, 127, 0, ' + opacity + ')',
            5: 'rgba(255, 36, 0, ' + opacity + ')',
        };

        var map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.MapQuest({layer: 'sat'})
                }),
                new ol.layer.Vector({
                    source: new ol.source.Vector({
                        loader: function() {
                            var source = this;
                            var format = new ol.format.GeoJSON();
                            dojo.xhrGet({
                                url: "data/countries_highres.json",
                                handleAs: "json",
                                load: function(data) {
                                    var features = format.readFeatures(data, {
                                        featureProjection: 'EPSG:3857'
                                    });
                                    source.addFeatures(separateMultiPolygon(features));
                                    countryData = data;
                                    initializeTask();
                                }
                            })
                        }
                    }),
                    style: function(feature) {
                        return fillCountry();
                    }
                })
            ],
            target: 'map',
            view: new ol.View({
                center: ol.proj.fromLonLat([19, 48]),
                zoom: 5,
                maxZoom: 8,
                minZoom: 3
            })
        });

        var overlayFeature = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(0,0,0,1)',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0,0,0,0.3)'
                })
            })
        });

        var correctAnswerFeature = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(0, 255, 0, 0.5)'
                })
            })
        });

        var textFeature = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: function(feature) {
                return getTextFeature(feature);
            }
        });


        function separateMultiPolygon(features) {
            var result = [];
            dojo.forEach(features, function(feature) {
                var geom = feature.getGeometry();
                if (geom.getType() === 'MultiPolygon') {
                    dojo.forEach(geom.getPolygons(), function(polygon) {
                        var clone = feature.clone();
                        clone.setGeometry(polygon);
                        result.push(clone);
                    })
                } else {
                    result.push(feature);
                }
            });

            return result;
        }

        function fillCountry() {
            var color = colorMap[1];
            var s = new ol.style.Style({
                fill: new ol.style.Fill({
                    color: color
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(0, 0, 0, 1)',
                    width: 0.4
                })
            })
            return  s;
        }

        function getTextFeature(feature) {
            var t = new ol.style.Text({
                text: feature.get("name"),
                font: "20px sans-serif",
                fill: new ol.style.Fill({
                    color: 'rgba(255,255,255,1)'
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(0,0,0,1)'
                })
            })
            var s = new ol.style.Style({
                text: t
            })
            return s;
        }


        function highlightFeatureInfo(pixel) {
            var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                return feature;
            });

            if (feature !== highlightFeature) {
                if (highlightFeature) {
                    overlayFeature.getSource().removeFeature(highlightFeature);
                    textFeature.getSource().removeFeature(highlightFeature);
                }
                if (feature) {
                    textFeature.getSource().addFeature(feature);
                    overlayFeature.getSource().addFeature(feature);
                } else {
                }
                highlightFeature = feature;
            }

        }

        function checkCorrectAnswer(pixel) {
            var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                return feature;
            });

            if (taskCountry && feature && feature.get("name") === taskCountry.name) {
                correctAnswerFeature.getSource().addFeature(feature);
                var fill = correctAnswerFeature.getStyle().getFill();
                if (settings.keepAnswer.length === 0) {
                    correctAnswerAnimate(fill, feature);
                }
                initializeTask();
            }
        }

        function nextTask() {
            initializeTask();
        }

        map.on('pointermove', function(evt) {
            if (evt.dragging) {
                return;
            }
            var pixel = map.getEventPixel(evt.originalEvent);
            highlightFeatureInfo(pixel);
        });

        map.on('click', function(evt) {
            checkCorrectAnswer(evt.pixel);
        });
    </script>
    <script>
        require(["dojo/dom", "dijit/registry"], function(dom, registry) {
            changeSetting = function(){
                initSettings();
            }

            initSettings = function() {
                var form = registry.byId("settingForm");
                settings = form.get("value");
            }
            initializeTask = function() {
                var taskSpan = dom.byId("taskSpan");
                var taskInfoSpan = dom.byId("taskInfoSpan");
                var randomNum = Math.floor(Math.random() * countryData.features.length);
                var country = countryData.features[randomNum].properties;

                taskInfoSpan.innerHTML = "Click on:";
                taskSpan.innerHTML = country.name;
                taskCountry = country;
            };

            correctAnswerAnimate = function(fill, feature) {
                var interval = 25;
                var timer = new dojox.timing.Timer(interval);
                timer.alpha = 0.5;
                timer.tickCount = 0;
                timer.fill = fill;
                timer.feature = feature;
                timer.onTick = function() {
                    timer.tickCount++;
                    var alpha = timer.alpha - (timer.alpha / interval * timer.tickCount);
                    timer.fill.setColor('rgba(0, 255, 0, ' + alpha + ')');

                    correctAnswerFeature.getSource().removeFeature(feature);
                    correctAnswerFeature.getSource().addFeature(feature);

                    if (alpha === 0) {
                        correctAnswerFeature.getSource().removeFeature(feature);
                        timer.fill.setColor('rgba(0, 255, 0, ' + timer.alpha + ')');
                        timer.stop();
                    }
                }
                timer.start();
            }
        });
    </script>

    <script>
        require(["dojo/ready"], function(ready) {
            ready(function() {
                dojo.require("dojox.timing");
                initSettings();
            })
        });
    </script>
</body>
</html>