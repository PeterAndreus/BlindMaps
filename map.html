 
<!DOCTYPE html>
<html>
    <head>
        <title>Image Vector Layer</title>
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/claro/claro.css">
        <link rel="stylesheet" href="http://openlayers.org/en/v3.13.1/css/ol.css" type="text/css">
        <script src="http://openlayers.org/en/v3.13.1/build/ol.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js" data-dojo-config="parseOnLoad: true"></script>

    </head>
    <body class="claro bodyClass">
        <style>
            .bodyClass{
                background-color: black;
            }
            .taskInfo{
                color: white;
                font-family: monospace;
                font-size: 1.6em;
            }
            .task{
                color: gainsboro;
                font-size: 2em;
                font-weight: bold;
                vertical-align: middle;
                display: inline-block;
                height: 100%;
            }
            .flagTask{
                height: 120px;
            }
            .settingTr{
                width: 30%;
            }
            .slider{
                width: 90%;
            }
            .topSlider .dijitSliderRemainingBar{
                background-color: red !important;
            }
            .topSlider .dijitSliderProgressBar{
                background-color: white !important;
            }
            .bottomSlider .dijitSliderRemainingBar{
                background-color: white !important;
            }
            .bottomSlider .dijitSliderProgressBar{
                background-color: red !important;
            }
        </style>
    <center>
        <div id='taskDiv'>
            <span class='taskInfo' id='taskInfoSpan'></span>
            <span class='task' id='taskSpan'></span>
        </div>
    </center>
    <div id='settings'>
        <div data-dojo-type="dijit/form/Form" id="settingForm">
            <div>
                <div data-dojo-type="dijit/TitlePane" title="Settings" data-dojo-props='open: false, duration: 200'>
                    <div data-dojo-type="dijit/layout/ContentPane" >
                        Country area:
                        <div data-dojo-type="dijit/form/HorizontalSlider"
                             class ='topSlider slider'
                             name = 'minArea'
                             onChange="changeSetting(this)"
                             data-dojo-props="
                             minimum: -10,
                             maximum: 17098242,
                             showButtons:false,
                             value: 50000,
                             clickSelect: false">
                            <ol data-dojo-type="dijit/form/HorizontalRuleLabels" container="topDecoration"
                                style="height:1em;font-size:75%;color:gray;">
                                <li>Vatican</li>
                                <li>Russia</li>
                            </ol>
                            <div data-dojo-type="dijit/form/HorizontalRule" container="topDecoration"
                                 count=11 style="height:5px;"></div>
                        </div>
                        <div data-dojo-type="dijit/form/HorizontalSlider"
                             class ='bottomSlider slider'
                             name = 'maxArea'
                             onChange="changeSetting(this)"
                             data-dojo-props="
                             minimum: -10,
                             maximum: 17098242,
                             value: 17098242,
                             showButtons:false,
                             clickSelect: false">
                            <div data-dojo-type="dijit/form/HorizontalRule" container="bottomDecoration"
                                 count=11 style="height:5px;"></div>
                            <ol data-dojo-type="dijit/form/HorizontalRuleLabels" container="bottomDecoration"
                                style="height:1em;font-size:75%;color:gray;">
                                <li>Vatican</li>
                                <li>Russia</li>
                            </ol>
                        </div>

                        <table style="width: 100%">
                            <tr class="settingTr">
                                <td>
                                    <input id="keepAnswer" name="keepAnswer" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="keepAnswer">Keep correct answer highlighted</label>
                                </td>
                                <td>
                                    <input id="americas" name="region" value="Americas" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="americas">North and South America</label>
                                </td>
                                <td>
                                    <input id="asia" name="region" value="Asia" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="asia">Asia</label>
                                </td>
                            </tr>
                            <tr class="settingTr">
                                <td>
                                    <input id="names" value="names" name="taskStyle" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="names">Show name task</label>
                                </td>
                                <td>
                                    <input id="europe" name="region" value="Europe" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="europe">Europe</label>
                                </td>
                                <td>
                                    <input id="africa" name="region" value="Africa" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="asia">Africa</label>
                                </td>
                            </tr>
                            <tr class="settingTr">
                                <td>
                                    <input id="flags" name="taskStyle" value="flags" data-dojo-type="dijit/form/CheckBox"  onChange="changeSetting(this)"/>
                                    <label for="flags">Show flag task</label>
                                </td>
                                <td>
                                    <input id="australia" name="region" value="Australia" data-dojo-type="dijit/form/CheckBox" checked onChange="changeSetting(this)"/>
                                    <label for="australia">Australia</label>
                                </td>
                            </tr>
                        </table>
                        <button data-dojo-type="dijit/form/Button" type="button">Restart
                            <script type="dojo/on" data-dojo-event="click" data-dojo-args="evt">
                                restart();
                            </script>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <center>
        <div id="map" class="map" style="width: 80%"></div>
    </center>
    <script>

        var settings;
        var countryData;
        var correctAnswers = [];
        var filteredData;
        var taskCountry;
        var highlightFeature;
        var opacity = 0.7;
        var colorMap = {
            1: 'rgba(255, 255, 255, ' + (opacity - 0.3) + ')',
            2: 'rgba(50, 205, 50, ' + opacity + ')',
            3: 'rgba(255, 215, 0, ' + opacity + ')',
            4: 'rgba(255, 127, 0, ' + opacity + ')',
            5: 'rgba(255, 36, 0, ' + opacity + ')',
        };

        var map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.MapQuest({layer: 'sat'})
                }),
                new ol.layer.Vector({
                    source: new ol.source.Vector({
                        loader: function() {
                            var source = this;
                            var format = new ol.format.GeoJSON();
                            dojo.xhrGet({
                                url: "data/countries_borders.json",
                                handleAs: "json",
                                load: function(data) {
                                    var features = format.readFeatures(data, {
                                        featureProjection: 'EPSG:3857'
                                    });
                                    source.addFeatures(separateMultiPolygon(features));
                                }
                            });
                        }
                    }),
                    style: function(feature) {
                        return fillCountry();
                    }
                })
            ],
            target: 'map',
            view: new ol.View({
                center: ol.proj.fromLonLat([19, 48]),
                zoom: 5,
                maxZoom: 11,
                minZoom: 3
            })
        });

        var overlayFeature = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(0,0,0,1)',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0,0,0,0.3)'
                })
            })
        });

        var correctAnswerFeature = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(0, 255, 0, 0.5)'
                })
            })
        });


        var wrongAnswerFeature = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(255, 0, 0, 0.5)'
                })
            })
        });


        function separateMultiPolygon(features) {
            var result = [];
            dojo.forEach(features, function(feature) {
                var geom = feature.getGeometry();
                if (geom.getType() === 'MultiPolygon') {
                    dojo.forEach(geom.getPolygons(), function(polygon) {
                        var clone = feature.clone();
                        clone.setGeometry(polygon);
                        result.push(clone);
                    })
                } else {
                    result.push(feature);
                }
            });

            return result;
        }

        function fillCountry() {
            var color = colorMap[1];
            var s = new ol.style.Style({
                fill: new ol.style.Fill({
                    color: color
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(0, 0, 0, 1)',
                    width: 0.4
                })
            })
            return  s;
        }


        function highlightFeatureInfo(pixel) {
            var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                return feature;
            });

            if (feature !== highlightFeature) {
                if (highlightFeature) {
                    overlayFeature.getSource().removeFeature(highlightFeature);
                }
                if (feature) {
                    overlayFeature.getSource().addFeature(feature);
                } else {
                }
                highlightFeature = feature;
            }

        }

        function checkCorrectAnswer(pixel) {
            var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                return feature;
            });
            if (feature && correctAnswers.indexOf(feature.get("ISO3")) !== -1) {
                var fill = wrongAnswerFeature.getStyle().getFill();
                wrongAnswerFeature.getSource().addFeature(feature);
                wrongAnswerAnimate(fill, feature);
                return;
            }

            if (taskCountry && feature && feature.get("ISO3") === taskCountry.cca3) {
                correctAnswerFeature.getSource().addFeature(feature);
                var fill = correctAnswerFeature.getStyle().getFill();
                if (settings.keepAnswer.length === 0) {
                    correctAnswerAnimate(fill, feature);
                }
                correctAnswers.push(taskCountry.ccn3);
                initializeTask();
            } else if (feature) {
                var fill = wrongAnswerFeature.getStyle().getFill();
                wrongAnswerFeature.getSource().addFeature(feature);
                wrongAnswerAnimate(fill, feature);
            }
        }

        function restart() {
            var vectorSource = correctAnswerFeature.getSource();
            dojo.forEach(vectorSource.getFeatures(), function(feature) {
                vectorSource.removeFeature(feature);
            });
            correctAnswers = [];
        }

        function nextTask() {
            initializeTask();
        }

        map.on('pointermove', function(evt) {
            if (evt.dragging) {
                return;
            }
            var pixel = map.getEventPixel(evt.originalEvent);
            highlightFeatureInfo(pixel);
        });

        map.on('click', function(evt) {
            checkCorrectAnswer(evt.pixel);
        });
    </script>
    <script>
        require(["dojo/dom", "dijit/registry", "dojo/dom-class"], function(dom, registry, domClass) {
            changeSetting = function() {
                initSettings();
            }

            initSettings = function() {
                var form = registry.byId("settingForm");
                settings = form.get("value");
                if(settings.taskStyle.indexOf("flags") !== -1){
                    domClass.add("taskDiv", "flagTask");
                }else{
                    domClass.remove("taskDiv", "flagTask");
                }
                filterDataByCriteria();
                restart();
            }

            filterDataByCriteria = function() {
                filteredData = dojo.filter(countryData.features, function(item) {
                    return settings.region.indexOf(item.region) !== -1 &&
                            item.area <= settings.maxArea &&
                            item.area >= settings.minArea;
                });
                initializeTask();
            }

            initializeTask = function() {
                var taskSpan = dom.byId("taskSpan");
                var taskInfoSpan = dom.byId("taskInfoSpan");
                if (correctAnswers.length !== filteredData.length) {
                    var country = getRandomCountry();
                    var taskSpanValue = "";

                    taskInfoSpan.innerHTML = "Click on:";
                    if (settings.taskStyle.indexOf("flags") !== -1) {
                        taskSpanValue += "<img src='http://www.geonames.org/flags/x/" + country.cca2.toLowerCase() + ".gif' width='100px'/> <br/>";
                    }
                    if (settings.taskStyle.indexOf("names") !== -1) {
                        taskSpanValue += country.name.common;
                    }
                    taskSpan.innerHTML = taskSpanValue;
                    taskCountry = country;
                } else {
                    taskInfoSpan.innerHTML = "";
                    taskSpan.innerHTML = "All answered";
                }
            };

            getRandomCountry = function() {
                var randomNum = Math.floor(Math.random() * filteredData.length);
                var country = filteredData[randomNum];
                if (correctAnswers.indexOf(country.ccn3) !== -1) {
                    country = getRandomCountry();
                }
                return country;
            }

            correctAnswerAnimate = function(fill, feature) {
                var interval = 25;
                var timer = new dojox.timing.Timer(interval);
                timer.alpha = 0.5;
                timer.tickCount = 0;
                timer.fill = fill;
                timer.feature = feature;
                timer.onTick = function() {
                    timer.tickCount++;
                    var alpha = timer.alpha - (timer.alpha / interval * timer.tickCount);
                    timer.fill.setColor('rgba(0, 255, 0, ' + alpha + ')');

                    correctAnswerFeature.getSource().removeFeature(feature);
                    correctAnswerFeature.getSource().addFeature(feature);

                    if (alpha === 0) {
                        correctAnswerFeature.getSource().removeFeature(feature);
                        timer.fill.setColor('rgba(0, 255, 0, ' + timer.alpha + ')');
                        timer.stop();
                    }
                };
                timer.start();
            };

            wrongAnswerAnimate = function(fill, feature) {
                var interval = 25;
                var timer = new dojox.timing.Timer(interval);
                timer.alpha = 0.5;
                timer.tickCount = 0;
                timer.fill = fill;
                timer.feature = feature;
                timer.onTick = function() {
                    timer.tickCount++;
                    var alpha = timer.alpha - (timer.alpha / interval * timer.tickCount);
                    timer.fill.setColor('rgba(255, 0, 0, ' + alpha + ')');

                    wrongAnswerFeature.getSource().removeFeature(feature);
                    wrongAnswerFeature.getSource().addFeature(feature);

                    if (alpha === 0) {
                        wrongAnswerFeature.getSource().removeFeature(feature);
                        timer.fill.setColor('rgba(255, 0, 0, ' + timer.alpha + ')');
                        timer.stop();
                    }
                };
                timer.start();
            };
        });
    </script>

    <script>
        require(["dojo/request/xhr", "dojo/ready"], function(xhr, ready) {
            ready(function() {
                dojo.require("dojox.timing");
                xhr("data/countries.json",
                        {handleAs: "json"})
                        .then(function(data) {
                            countryData = data;
                            initSettings();
                        });
            })
        });
    </script>
</body>
</html>